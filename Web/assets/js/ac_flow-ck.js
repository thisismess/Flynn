AC.Flow=AC.Class({__defaultOptions:{fps:24,diffStart:1,benchmark:!1},initialize:function(t,n,r,i){if(!AC.Environment.Feature.supportsCanvas()){this.__publish("degraded");return!1}this.setOptions(i);this._delegate={};this._canPlay=!1;this._width=null;this._height=null;this._loaded=!1;this._diff=null;this._keyframe=null;this._framecount=null;this._currentFrame=-1;AC.Object.synthesize(this);this.__isPlaying=!1;this.__blocksPerFullDiff=null;this.__columnsInCanvas=null;this.__frames=null;this.__diffSrc=t;this.__manifest=new AC.Flow.Manifest(n);AC.NotificationCenter.subscribe(AC.Flow.notificationPrefix()+"manifestLoaded",this.__onManifestLoad.bind(this),this.__manifest);if(this.options().benchmark===!0&&typeof Stats!="undefined"&&!AC.Flow.stats){var s="ac-flow-benchmark-stats",o=AC.Element.selectAll("."+s);AC.Flow.stats=new Stats;document.body.appendChild(AC.Flow.stats.domElement);AC.Element.addClassName(AC.Flow.stats.domElement,s);AC.Flow.stats.domElement.id=s+"-"+o.length;AC.Flow.stats.domElement.title=r;AC.Flow.stats.domElement.style.position="fixed";AC.Flow.stats.domElement.style.top=0;AC.Flow.stats.domElement.style.left=o.length*80+"px";AC.Flow.stats.domElement.style.zIndex=1e4;AC.Flow.stats.setMode(0)}this.__loadImage(this.__getKeyframeSrc(r),this.__onDidLoadKeyframe.bind(this))},play:function(t,n){if(this.__isPlaying===!0)return!1;n=typeof n=="object"?n:{};this.__doWhenCanPlay(this.__play,[t,n])},pause:function(){if(this.__isPlaying===!0){this.__isPlaying=!1;window.clearTimeout(this.__animationTimeout);this.__publish("didPause",!0)}},showFrame:function(t,n,r,i){if(isNaN(n))return!1;this.pause();AC.Element.isElement(i)&&i.tagName.toLowercase()==="img"&&(i=i.getAttribute("src"));if(typeof i=="string"){var s=this;this.__loadImage(i,function(e){s.setCurrentFrame.apply(s,[n]);s.__showImage.apply(s,[t,e])})}else this.__doWhenCanPlay(this.__showFrame,[t,n,r])},setupCanvas:function(t,n){var r;t=AC.Element.getElementById(t);if(!AC.Element.isElement(t)||t.tagName.toLowerCase()!=="canvas")throw"Playing a sequence requires a canvas tag to be present.";r=t.getContext("2d");t.getAttribute("width")===null&&t.setAttribute("width",this.width());t.getAttribute("height")===null&&t.setAttribute("height",this.height());n===!0&&this.__showImage(t,this.keyframe());return r},cleanup:function(){this.setCanPlay(!1);this.setLoaded(!1);this.setKeyframe(null);this._diff=null;this.__diffSrcs=null;this.__frames=null;this.__manifest=null}});AC.Flow.version="1.0";typeof document!="undefined"&&document.createElement("canvas");AC.Flow.createHighBitNumber=function(e,t){return(e<<8)+t};AC.Flow.valueForCharAt=function(e,t){var n=e.charCodeAt(t);if(n>64&&n<91)return n-65;if(n>96&&n<123)return n-71;if(n>47&&n<58)return n+4;if(n===43)return 62;if(n===47)return 63;throw"Invalid Bas64 character: "+e.charAt(t)};AC.Flow.createNumberFromBase64Range=function(e,t,n){var r=0,i;while(n--){i=AC.Flow.valueForCharAt(e,t++);r+=i<<n*6}return r};AC.Flow.notificationPrefix=function(){return AC.Flow._notificationPrefix};AC.Flow._notificationPrefix="ac-flow-";AC.Object.extend(AC.Flow.prototype,{__applyDiff:function(t,n,r,i,s,o){var u;if(n)for(u=0;u<n.length;u+=1)this.__applyDiffRange(t,n[u],r,i,s,o)},__applyDiffRange:function(t,n,r,i,s,o){var u=n.block,a=n.length,f=Math.floor(u/this.__blocksPerFullDiff),l=o[f].width,c=u%this.__blocksPerFullDiff,h=l/r,p=c%h*r,d=Math.floor(c/(h||1))*r,v=n.location%this.__columnsInCanvas*r,m=Math.floor(n.location/this.__columnsInCanvas)*r,g,y;while(a){g=Math.min(a*r,s-v,l-p);y=g/r;t.clearRect(v,m,g,r);t.drawImage(o[f],p,d,g,r,v,m,g,r);a-=y;if(a){if((p+=g)>=l){p=0;d+=r}if((c+=y)>=this.__blocksPerFullDiff){c=0;p=0;d=0;f+=1;f===i-1&&(l=o[f].width)}if((v+=g)>=s){v=0;m+=r}u+=y}}}});AC.Object.extend(AC.Flow.prototype,{__diffImageLoaded:function(){isNaN(this.__diffLoadedCount)&&(this.__diffLoadedCount=0);this.__diffLoadedCount+=1;if(this.__diffLoadedCount===this.__manifest.diffImageCount()){this.__onDiffLoaded();this.setLoaded(!0);this.__publish("didLoad",!0);this.__canPlay();delete this.__diffLoadedCount}},__frameStringFromNumber:function(t,n){var r=t+"";while(r.length<n)r="0"+r;return r},setDiff:function(t){if(this._diff!==null)throw"Diff cannot be set more than once";var n=t.match(/^([^#]*)(#+)([^#]*)$/),r,i,s=0,o=this.__diffImageLoaded.bind(this);this._diff=[];this.__diffSrcs=[];for(r=this.options().diffStart;r<=this.__manifest.diffImageCount()+(this.options().diffStart-1);r+=1){i=n[1]+this.__frameStringFromNumber(r,n[2].length)+n[3];this.__diffSrcs.push(i);this._diff.push(this.__loadImage(i,o))}}});AC.namespace("AC.Flow.SharedMethods");AC.Flow.SharedMethods.setOptions=function(e){if(typeof this._options!="undefined")throw"Options cannot be set more than once";var t=AC.Object.clone(this.__defaultOptions);typeof e=="object"?this._options=AC.Object.extend(t,e):this._options=t};AC.Flow.SharedMethods.__publish=function(e,t,n){n=typeof n=="undefined"?this:n;AC.NotificationCenter.publish(AC.Flow.notificationPrefix()+e,{target:this,data:n},!0);var r="on"+e.slice(0,1).toUpperCase()+e.slice(1,e.length);t===!0&&typeof this.delegate()[r]=="function"&&this.delegate()[r](n)};AC.Flow.SharedMethods.__doWhenCanPlay=function(e,t){if(this.canPlay())e.apply(this,t);else{var n=this,r=function(r){e.apply(n,t)};AC.NotificationCenter.subscribe(AC.Flow.notificationPrefix()+"canPlay",r,this)}};AC.Flow.SharedMethods.__setupContainer=function(){typeof this.setContext!="function"&&(this._context=null);typeof this.setCanvas!="function"&&(this._context=null);AC.Object.synthesize(this);this.container().innerHTML="";if(this.container().tagName.toLowerCase()==="canvas")this.setCanvas(this.container());else{this.setCanvas(document.createElement("canvas"));this.container().appendChild(this.canvas())}this.setContext(this.canvas().getContext("2d"))};AC.Flow.SharedMethods.benchmarkStart=function(){if(AC.Flow.stats){AC.Flow.stats.__isCounting&&AC.Flow.stats.end();AC.Flow.stats.begin();AC.Flow.stats.__isCounting=!0}};AC.Flow.SharedMethods.benchmarkEnd=function(){if(AC.Flow.stats){AC.Flow.stats.__isCounting&&AC.Flow.stats.end();AC.Flow.stats.__isCounting=!1}};AC.Object.extend(AC.Flow.prototype,{__onDiffLoaded:function(){this.__blocksPerFullDiff=this.diff()[0].width/this.__manifest.size()*(this.diff()[0].height/this.__manifest.size())},__onDidLoadKeyframe:function(t){this.setKeyframe(t);this.setWidth(t.width);this.setHeight(t.height);this.__publish("didLoadKeyframe",!0);this.__canPlay()},__onManifestLoad:function(){this.setDiff(this.__diffSrc);delete this.__diffSrc;this.setFramecount(this.__manifest.framecount()+1);this.__frames=[null].concat(this.__manifest.frames());this.__canPlay()},__onBeforeCanPlay:function(){this.__columnsInCanvas=this.width()/this.__manifest.size()},__publish:AC.Flow.SharedMethods.__publish});AC.Object.extend(AC.Flow.prototype,{__play:function(t,n){var r=this,i=this.framecount();n.fps=isNaN(n.fps)?this.options().fps:n.fps;n.toFrame=!isNaN(n.toFrame)&&n.toFrame>=0&&n.toFrame<i?n.toFrame:i-1;var s=1e3/n.fps,o=this.setupCanvas(t,!1),u=this.currentFrame(),a=n.continuous===!0?Infinity:n.toFrame,f=a<=this.currentFrame(),l=this.__manifest.size(),c=this.__manifest.diffImageCount(),h=this.width(),p=this.diff();this.__isPlaying=!0;this.__publish("willPlay",!0);var d=function(){var e=new Date;u+=1;AC.Flow.SharedMethods.benchmarkStart();r.__frames[u]?r.__applyDiff.apply(r,[o,r.__frames[u],l,c,h,p]):r.__showImage(t,r.keyframe());if((u<a||f===!0)&&r.__isPlaying===!0){if(u>=i-1){f=!1;r.__publish("didPlay",!0);r.__reset();u=-1}else r.setCurrentFrame(u);r.__animationTimeout=window.setTimeout(d,Math.max(s-(new Date-e),10))}else{if(AC.Flow.stats){var n=new Date-AC.Flow.stats.__benchmarkTimer,v=n-s*i,y=v>200?"warn":"log";try{console[y]("Benchmark: "+(v>=0?"+":"")+v/1e3)}catch(w){}AC.Flow.stats.__isCounting=!1}r.__isPlaying=!1;r.setCurrentFrame(u);r.__publish("didPlay",!0)}};AC.Flow.stats&&(AC.Flow.stats.__benchmarkTimer=new Date);this.__animationTimeout=window.setTimeout(d,s)},__reset:function(){this.setCurrentFrame(0)},__showFrame:function(t,n,r){var i,s,o=this.__manifest.size(),u=this.__manifest.diffImageCount(),a=this.width(),f=this.diff();if(n<=this.currentFrame()||r===!0){this.__reset();i=this.setupCanvas(t,!0)}else{this.currentFrame()!==0&&this.setCurrentFrame(this.currentFrame()+1);i=this.setupCanvas(t)}for(s=this.currentFrame();s<=Math.min(n,this.__frames.length-1);s+=1)this.__applyDiff(i,this.__frames[s],o,u,a,f);this.setCurrentFrame(n)},__loadImage:function(t,n){var r=new Image;r.onload=function(){typeof n=="function"&&n(r)};r.onerror=function(e){throw"Image not found: "+t};r.src=t;return r},__showImage:function(t,n){var r;t=AC.Element.getElementById(t);r=t.getContext("2d");t.getAttribute("width")===null&&t.setAttribute("width",n.width);t.getAttribute("height")===null&&t.setAttribute("height",n.height);r.drawImage(n,0,0)},__getKeyframeSrc:function(t){AC.Element.isElement(t)&&t.tagName.toLowerCase()==="img"&&(t=t.getAttribute("src"));if(typeof t!="string"||t==="")throw"Keyframe provided is not valid IMG tag or src string.";return t},__canPlay:function(){if(this.canPlay()!==!0){if(this.__manifest.loaded()===!0&&this.keyframe()!==null&&this.loaded()===!0){this.__onBeforeCanPlay();this.setCanPlay(!0);this.__publish("canPlay",!0);return!0}return!1}return!0},__doWhenCanPlay:AC.Flow.SharedMethods.__doWhenCanPlay,setOptions:AC.Flow.SharedMethods.setOptions});AC.Flow.Ambient=AC.Class();AC.Flow.Ambient.prototype={__defaultOptions:{autoplay:!0,cleanup:!0,endState:null},initialize:function(t,n,r,i,s){if(!AC.Environment.Feature.supportsCanvas())return!1;this.setOptions(s);this._delegate={};this._container=AC.Element.getElementById(t);this._canvas=null;this._context=null;AC.Object.synthesize(this);if(!AC.Element.isElement(this.container()))throw"Valid Element required for playing Ambient Sequence.";i||(i=AC.Element.select("img",this.container()));this.__setupContainer();this.__setupSequence(n,r,i)},play:function(t){this.__sequence.play(this.canvas(),t)},cleanup:function(){this.setContainer(null);this.setCanvas(null);this.setContext(null);this.__endState=null;this.play=AC.Function.emptyFunction;this.__sequence.cleanup()}};AC.Object.extend(AC.Flow.Ambient.prototype,{onDidLoadKeyframe:function(t){t.setupCanvas(this.canvas(),!0)},onCanPlay:function(t){typeof this.options().endState=="string"&&this.__preloadEndState();this.__publish("canPlay",!0)},onWillPlay:function(t){this.__publish("willPlay",!0)},onDidPlay:function(t){if(typeof this.options().endState=="string"){var n=this,r=function(){n.context().drawImage(n.__endState,0,0,n.__sequence.width(),n.__sequence.height())};this.__endState?r():this.__preloadEndState(r)}this.__publish("didPlay",!0);this.options().cleanup&&this.cleanup()}});AC.Object.extend(AC.Flow.Ambient.prototype,{__setupSequence:function(t,n,r){this.__sequence=new AC.Flow(t,n,r,this.options());this.__sequence.setDelegate(this);this.options().autoplay===!0&&this.__sequence.play(this.canvas())},__preloadEndState:function(t){if(this.__preloadedEndState)return;var n=this,r=new Image;if(AC.Retina.sharedInstance().shouldReplace("img-tag")&&typeof this.__replacedEndstateWith2x=="undefined"){var i=this.options().endState.replace(/(\.[a-z]{3})/,"_2x$1");AC.Ajax.checkURL(i,function(e){n.__replacedEndstateWith2x=e;e===!0&&(n.options().endState=i);n.__preloadEndState.call(n,t)})}else{r.onload=function(){n.__endState=r;typeof t=="function"&&t(r)};r.src=this.options().endState;this.__preloadedEndState=!0}},__setupContainer:AC.Flow.SharedMethods.__setupContainer,__publish:AC.Flow.SharedMethods.__publish,setOptions:AC.Flow.SharedMethods.setOptions});AC.Flow.BiDirectional=AC.Class({__defaultOptions:{},initialize:function(t,n,r){if(!AC.Environment.Feature.supportsCanvas())return!1;this.setOptions(r);this._forwards=t;this._backwards=n;this._delegate={};this._canPlay=!1;this._currentFlow=t;this._playing=!1;AC.Object.synthesize(this);this.forwards().setDelegate(this);this.backwards().setDelegate(this);this.__sync();var i=this.__canPlay.bind(this);AC.NotificationCenter.subscribe(AC.Flow.notificationPrefix()+"canPlay",i,this.forwards());AC.NotificationCenter.subscribe(AC.Flow.notificationPrefix()+"canPlay",i,this.backwards())},play:function(t,n){if(this.playing()===!0)return!1;this.__doWhenCanPlay(this.__play,[t,n])},pause:function(){if(this.playing()===!0){this.currentFlow().pause();this.setPlaying(!1);this.__sync()}},showFrame:function(t,n,r,i){this.pause();this.__doWhenCanPlay(this.__showFrame,[t,n,r,i])}});AC.Object.extend(AC.Flow.BiDirectional.prototype,{onWillPlay:function(t){this.__publish("willPlay",!0)},onDidPause:function(t){this.__publish("didPause",!0)},onDidPlay:function(t){this.setPlaying(!1);this.__sync();this.__publish("didPlay",!0)}});AC.Object.extend(AC.Flow.BiDirectional.prototype,{__play:function(t,n){var r=n.direction<0?this.backwards():this.forwards();this.setCurrentFlow(r);typeof n.toFrame!="undefined"&&this.currentFlow()===this.backwards()&&(n.toFrame=this.currentFlow().framecount()-1-n.toFrame);r.play(t,n);this.setPlaying(!0)},__showFrame:function(t,n,r,i){var s,o=this.__determineRelativeDeltaForwards(n),u=this.__determineRelativeDeltaBackwards(n);typeof i=="string"?s=this.forwards():s=this.__chooseFlowByDelta(o,u);var a=s===this.forwards()?n:this.currentFlow().framecount()-1-n;this.playing()===!0&&this.pause();s.showFrame(t,a,r,i);this.__sync()},__sync:function(){var t,n,r;if(this.currentFlow()===this.forwards()){t=this.forwards();n=this.backwards()}else{t=this.backwards();n=this.forwards()}r=n.framecount()-1-t.currentFrame();n.setCurrentFrame(r)},__determineRelativeDeltaForwards:function(t){var n=t-this.forwards().currentFrame();n<0&&(n=t);return n},__determineRelativeDeltaBackwards:function(t){var n=this.backwards().framecount()-1-t-this.backwards().currentFrame();n<0&&(n=this.backwards().framecount()-1-t);return n},__chooseFlowByDelta:function(t,n){Math.abs(t)<=Math.abs(n)?this.setCurrentFlow(this.forwards()):this.setCurrentFlow(this.backwards());return this.currentFlow()},__canPlay:function(){if(this.canPlay()===!0)return!0;if(this.forwards().canPlay()&&this.backwards().canPlay()){this.setCanPlay(!0);this.__publish("canPlay",!0);return!0}return!1},__doWhenCanPlay:AC.Flow.SharedMethods.__doWhenCanPlay,__publish:AC.Flow.SharedMethods.__publish,setOptions:AC.Flow.SharedMethods.setOptions});AC.Flow.Manifest=AC.Class({initialize:function(t){if(!AC.Environment.Feature.supportsCanvas())return!1;this._diffImageCount=null;this._framecount=null;this._frames=[];this._key=null;this._loaded=!1;this._size=null;this._version=null;AC.Object.synthesize(this);this.__loadManifest(t)},__loadManifest:function(t){t.match(/\.png((#|\?).*)?$/)?this.__loadManifestImage(t):this.__loadManifestJSON(t)},__loadManifestJSON:function(t){var n=this.__parseData.bind(this),r=this;t=t.replace(/^https?:\/\/[^\/]+\//i,"/");var i=new AC.Ajax.AjaxRequest(t,{onSuccess:function(t){n(t);r.__storeBlockLocations.call(r)},onFailure:function(){throw"Manifest file not found at "+t},onError:function(){throw"Error loading JSON file at "+t}})},__parseData:function(t){typeof this.__boundReadFrame!="function"&&(this.__boundReadFrame=this.__readFrame.bind(this));if(!isNaN(t))this.__setKeyFromPixelData.apply(this,arguments);else if(typeof t=="object"&&typeof t.responseJSON=="function"){t=t.responseJSON();this.__setKeyFromJSONData(t)}typeof this.key()=="object"&&typeof this.key().parseData=="function"&&this.key().parseData.apply(this,arguments)},__setKeyFromJSONData:function(t){if(typeof t.version=="undefined")throw"JSON Manifest requires property ‘version’ to be defined.";this.setVersion(t.version);this.setKey(AC.Flow.Manifest.Keys[this.version()])},__readHeader:function(t){this.key().parseHeader.call(this,t);this.__headerRead=!0},__readFrame:function(t){this.key().parseFrame.call(this,t)},__storeBlockLocations:function(){var t=0,n=this.frames(),r,i;for(r=0;r<n.length;r+=1)for(i=0;i<n[r].length;i+=1){n[r][i].block=t;t+=n[r][i].length}},setKey:function(t){if(typeof t!="object"||typeof t.parseData!="function")throw"Manifest Version "+this.version()+" not understood by this version of AC.Flow.Manifest.";this._key=t},setLoaded:function(t){if(this._loaded)throw"Already loaded manifest! Cannot load it twice.";this._loaded=!!t;this._loaded&&AC.NotificationCenter.publish(AC.Flow.notificationPrefix()+"manifestLoaded",{target:this,data:this},!0)}});AC.Object.extend(AC.Flow.Manifest.prototype,{__loadManifestImage:function(t){var n=this.__parseData.bind(this),r=this;AC.Canvas.imageDataFromFile(t,function(e){r.__pixelCount=e.data.length/4;AC.Canvas.iterateImageData(e,n);r.__storeBlockLocations.call(r)})},__setKeyFromPixelData:function(t,n,r,i,s){if(s===0){this.setVersion(t);this.setKey(AC.Flow.Manifest.Keys[this.version()])}},__readUntilNextMarker:function(t,n){Array.isArray(this.__temporaryData)||(this.__temporaryData=[]);if(this.key().isMarker.call(this,t)){n(this.__temporaryData);delete this.__temporaryData}else this.__temporaryData.push(t)}});AC.Flow.Manifest.Keys={};AC.Flow.Manifest.Keys[2]={parseData:function(t){var n;this.__readHeader(t);for(n=0;n<t.frames.length;n+=1)this.__readFrame(t.frames[n]);this.setLoaded(!0)},parseHeader:function(t){this.setFramecount(t.frameCount);this.setSize(t.blockSize);this.setDiffImageCount(t.imagesRequired)},parseFrame:function(t){var n=[],r;for(r=0;r<t.length;r+=5)n.push({location:AC.Flow.createNumberFromBase64Range(t,r,3),length:AC.Flow.createNumberFromBase64Range(t,r+3,2)});this.frames().push(n)}};AC.Flow.VR=AC.Class({__defaultOptions:{extension:"jpg",autoplay:!0,autoplayDirection:1,continuous:!0,scrubbable:!0,scrubRotateDistance:1e3,scrubDirection:-1,scrubHeartbeat:.04,playOnScrubEnd:!1,throwable:!0,minThrowDuration:.5,maxThrowDuration:1.5,stopEventThreshold:10},initialize:function(t,n,r){this.setOptions(r);this._delegate={};this._container=AC.Element.getElementById(t);this._canvas=null;this._context=null;this._scrubbing=!1;this._throwing=!1;this._flow=null;AC.Object.synthesize(this);if(AC.Environment.Feature.supportsCanvas()){this.options().playOnScrubEnd===!0&&(this.options().throwable=!1);if(!AC.Element.isElement(this.container()))throw"Valid Element required for a AC.Flow.VR.";this.__setupContainer();this.__setupFlow(n);this.options().autoplay===!0?this.play({direction:this.options().autoplayDirection,fps:this.options().fps}):this.flow().showFrame(this.canvas(),0,!0);this.options().scrubbable===!0&&this.__enableScrubbing();if(this.options().throwable===!0){this.__minThrowFrames=Math.floor(this.options().minThrowDuration*this.options().fps);this.__maxThrowFrames=Math.floor(this.options().maxThrowDuration*this.options().fps)}}},play:function(t){if(this.scrubbing()===!1){t=typeof t=="object"?t:{};t.fps=isNaN(t.fps)?this.options().fps:t.fps;t.continuous=typeof t.continuous=="boolean"?t.continuous:this.options().continuous;this.__stopThrowing();this.flow().play(this.canvas(),t)}},pause:function(){this.flow().pause()}});AC.Object.extend(AC.Flow.VR.prototype,{onWillPlay:function(t){this.__publish("willPlay",!0)},onDidPause:function(t){this.__publish("didPause",!0)},onDidPlay:function(t){this.__publish("didPlay",!0)}});AC.Object.extend(AC.Flow.VR.prototype,{__startHeartbeat:function(){typeof this.__boundRunHeartbeat=="undefined"&&(this.__boundRunHeartbeat=this.__runHeartbeat.bind(this));this.__heartbeatFunction=null;this.__heartbeat=window.setInterval(this.__boundRunHeartbeat,this.options().scrubHeartbeat*1e3)},__endHeartbeat:function(){window.clearInterval(this.__heartbeat);delete this.__heartbeat},__runOnHeartbeat:function(t){this.__heartbeatFunction=t},__runHeartbeat:function(){typeof this.__heartbeatFunction=="function"&&this.__heartbeatFunction.call(this);this.__heartbeatFunction=null}});AC.Object.extend(AC.Flow.VR.prototype,{__setupFlow:function(t){var n,r,i,s="json",o="jpg",u=this.options().extension.replace(/^(\.)/,""),a={};typeof this.options().fps!="undefined"&&(a.fps=this.options().fps);t=t.match(/(\/)$/)?t:t+"/";r=new AC.Flow(t+"forwards_###."+u,t+"forwards_manifest."+s,t+"forwards_keyframe."+o,a);i=new AC.Flow(t+"backwards_###."+u,t+"backwards_manifest."+s,t+"backwards_keyframe."+o,a);this.setFlow(new AC.Flow.BiDirectional(r,i));this.flow().setDelegate(this);typeof this.options().fps=="undefined"&&(this.options().fps=this.flow().forwards().options().fps)},__getRelativeEvent:function(t){if(t.touches){if(t.touches.length>1)return!1;if(t.touches.length){t.clientX=t.touches[0].clientX;t.clientY=t.touches[0].clientY}typeof t.clientX=="undefined"&&(t.clientX=this.__onScrubMove.clientX);typeof t.clientY=="undefined"&&(t.clientY=this.__onScrubMove.clientY)}return t},__showFrameFromEvent:function(t){var n=this.__getScrubFrame(t,this.__onScrubStart.frame,this.__onScrubStart.clientX);this.__showFrame(n)},__showFrame:function(t){this.flow().showFrame(this.canvas(),t)},__setupContainer:AC.Flow.SharedMethods.__setupContainer,__publish:AC.Flow.SharedMethods.__publish,setOptions:AC.Flow.SharedMethods.setOptions});AC.Object.extend(AC.Flow.VR.prototype,{__enableScrubbing:function(){var t=AC.Function.bindAsEventListener(this.__onScrubStart,this),n=AC.Function.bindAsEventListener(this.__onScrubMove,this),r=AC.Function.bindAsEventListener(this.__onScrubEnd,this);AC.Element.addEventListener(this.container(),"touchstart",t);AC.Element.addEventListener(window,"touchmove",n);AC.Element.addEventListener(window,"touchend",r);AC.Element.addEventListener(this.container(),"mousedown",t);AC.Element.addEventListener(window,"mousemove",n);AC.Element.addEventListener(window,"mouseup",r);AC.Element.addClassName(this.container(),"grabbable")},__onScrubStart:function(t){if(this.options().scrubbable!==!0)return!1;if(t.touches&&t.touches.length>1)return!1;this.options().stopEventThreshold===!1||!t.touches&&!isNaN(this.options().stopEventThreshold)?AC.Event.stop(t):this.__stoppedEvent=!1;this.__stopThrowing();this.__onScrubStart.playing=this.flow().playing();this.pause();this.__endHeartbeat();t=this.__getRelativeEvent(t);this.__onScrubStart.clientX=t.clientX;this.__onScrubStart.clientY=t.clientY;this.__onScrubStart.frame=this.flow().forwards().currentFrame();this.__updateScrubHistory(t.clientX);this.setScrubbing(!0);this.__publish("scrubStart",!0,[this,[t.clientX,t.clientY]])},__onScrubMove:function(t){if(this.scrubbing()!==!0)return!1;t=this.__getRelativeEvent(t);this.__onScrubMove.clientX=t.clientX;this.__onScrubMove.clientY=t.clientY;if(!isNaN(this.options().stopEventThreshold)&&Math.abs(this.__onScrubStart.clientX-this.__onScrubMove.clientX)>=this.options().stopEventThreshold){AC.Event.stop(t);this.__stoppedEvent=!0}this.__updateScrubHistory(t.clientX);var n=function(){AC.Flow.SharedMethods.benchmarkStart();this.__showFrameFromEvent(t);this.__publish("scrubMove",!0,this.flow().forwards().currentFrame())}.bind(this);if(this.options().scrubHeartbeat&&!isNaN(this.options().scrubHeartbeat))if(typeof this.__heartbeat=="undefined"){this.__startHeartbeat();n()}else this.__runOnHeartbeat(n);else window.requestAnimationFrame(n)},__onScrubEnd:function(t){if(this.scrubbing()!==!0)return!1;t=this.__getRelativeEvent(t);this.options().scrubHeartbeat&&!isNaN(this.options().scrubHeartbeat)&&this.__endHeartbeat();this.setScrubbing(!1);this.__stoppedEvent===!1||this.options().playOnScrubEnd===!0?this.flow().play(this.canvas()):this.options().throwable===!0&&this.__throw(t.clientX);AC.Flow.SharedMethods.benchmarkEnd();this.__publish("scrubEnd",!0,[this,[t.clientX,t.clientY]])},__getScrubFrame:function(t,n,r){var i=t.clientX-r,s=i/this.options().scrubRotateDistance,o=Math.round((this.flow().forwards().framecount()-1)*s),u=n+o*this.options().scrubDirection;while(u<0)this.options().continuous===!1?u=0:u+=this.flow().forwards().framecount();while(u>=this.flow().forwards().framecount())this.options().continuous===!1?u=this.flow().forwards().framecount()-1:u-=this.flow().forwards().framecount();return u},__updateScrubHistory:function(t){typeof this.__scrubHistory=="undefined"&&(this.__scrubHistory=[]);this.__scrubHistory.unshift(t);this.__scrubHistory.length>3&&this.__scrubHistory.splice(3)},setScrubbing:function(t){this._scrubbing=t;t===!0?AC.Element.addClassName(document.body,"grabbing"):AC.Element.removeClassName(document.body,"grabbing")}});AC.Object.extend(AC.Flow.VR.prototype,{__throw:function(t){if(!Array.isArray(this.__scrubHistory))return;var n=this.__scrubHistory[this.__scrubHistory.length-1],r=t-n,i=Math.floor(r/5),s,o,u,a;if(r){i<this.__minThrowFrames?i=this.__minThrowFrames:i>this.__maxThrowFrames&&(i=this.__maxThrowFrames);this.__throwSequence=[];for(s=0;s<i;s+=1){o=s/i;u=Math.pow(o-1,2);n=Math.floor(u*r)+n;a=this.__getScrubFrame({clientX:n},this.__onScrubStart.frame,this.__onScrubStart.clientX);if(this.__throwSequence.length&&a===this.__throwSequence[this.__throwSequence.length-2])break;this.__throwSequence.push(a)}this.setThrowing(!0);this.__publish("willThrow",!0,this.__throwSequence);this.__throwStep()}},__throwStep:function(){if(!this.throwing())return;this.__throwStepTimer=new Date;typeof this.__boundThrowStep=="undefined"&&(this.__boundThrowStep=this.__throwStep.bind(this));AC.Flow.SharedMethods.benchmarkStart();this.__showFrame(this.__throwSequence.shift());this.__publish("didThrowStep",!0,this.__throwSequence);if(this.__throwSequence.length)window.setTimeout(this.__boundThrowStep,Math.max(1e3/this.options().fps-(new Date-this.__throwStepTimer),10));else{AC.Flow.SharedMethods.benchmarkEnd();this.__stopThrowing()}},__stopThrowing:function(){if(!this.throwing())return;this.setThrowing(!1);this.__publish("didThrow",!0);delete this.__scrubHistory}});